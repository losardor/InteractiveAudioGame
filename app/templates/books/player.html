{% extends 'layouts/base.html' %}

{% block custom_head_tags %}
<meta name="theme-color" content="#1a1a2e">
<style>
    .player-container {
        max-width: 480px;
        margin: 0 auto;
        padding: 24px 16px 48px;
    }
    .player-book-title {
        text-align: center;
        color: #8888aa;
        font-size: 0.85em;
        margin-bottom: 24px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }
    .player-book-title a {
        color: inherit;
        text-decoration: none;
    }
    .player-book-title a:hover {
        color: #aaaacc;
    }
    .player-audio {
        background: #16213e;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
    }
    .player-audio audio {
        width: 100%;
        border-radius: 8px;
    }
    .audio-error {
        color: #ff6b6b;
        text-align: center;
        padding: 12px;
        display: none;
    }
    .transcript-toggle {
        display: block;
        width: 100%;
        background: none;
        border: 1px solid #333355;
        color: #8888aa;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        text-align: left;
        margin-bottom: 16px;
        min-height: 48px;
    }
    .transcript-toggle:hover {
        border-color: #5555aa;
        color: #aaaacc;
    }
    .transcript-text {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        padding: 0 8px;
        line-height: 1.7;
        font-size: 1em;
        color: #ccccdd;
    }
    .transcript-text.open {
        max-height: 800px;
        padding: 12px 8px 20px;
    }
    .no-audio-text {
        padding: 20px 4px;
        line-height: 1.7;
        font-size: 1.05em;
        color: #ccccdd;
    }
    #choices {
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    #choices.hidden {
        opacity: 0;
        transform: translateY(16px);
        pointer-events: none;
    }
    #choices.visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    .choice-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 16px 20px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #e85d04, #dc2f02);
        border: none;
        border-radius: 12px;
        color: #fff;
        font-size: 1.05em;
        font-weight: 500;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        min-height: 56px;
        line-height: 1.4;
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .choice-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(232, 93, 4, 0.3);
        color: #fff;
    }
    .choice-btn:active {
        transform: scale(0.98);
    }
    .skip-btn {
        display: block;
        background: none;
        border: 1px solid #444466;
        color: #8888aa;
        font-size: 0.85em;
        cursor: pointer;
        margin: 8px auto 20px;
        padding: 10px 24px;
        border-radius: 8px;
        min-height: 48px;
    }
    .skip-btn:hover {
        border-color: #6666aa;
        color: #aaaacc;
    }
    .story-end {
        text-align: center;
        padding: 32px 0;
    }
    .story-end h2 {
        color: #e0e0e0;
        font-size: 1.5em;
        margin-bottom: 24px;
    }
    .library-btn {
        display: inline-block;
        padding: 14px 32px;
        border: 1px solid #e85d04;
        border-radius: 12px;
        color: #e85d04;
        font-size: 1em;
        text-decoration: none;
        min-height: 48px;
        line-height: 1.4;
    }
    .library-btn:hover {
        background: rgba(232, 93, 4, 0.1);
        color: #e85d04;
    }
</style>
{% endblock %}

{% block nav %}{% endblock %}

{% block content %}
<script>document.body.classList.add('player-page');</script>

<div class="player-container">
    <div class="player-book-title">
        <a href="{{ url_for('books.book_info', book_id=book.id) }}">{{ book.name }}</a>
    </div>

    {% if audio_url %}
    <div class="player-audio">
        <audio id="story-audio" controls preload="metadata">
            <source src="{{ audio_url }}" />
            Your browser does not support audio playback.
        </audio>
        <div id="audio-error" class="audio-error">Audio not available</div>
    </div>

    {% if text_content %}
    <button class="transcript-toggle" id="transcript-btn">Read transcript</button>
    <div class="transcript-text" id="transcript">{{ text_content }}</div>
    {% endif %}

    {% else %}
    {# No audio: show text directly, choices visible immediately #}
    {% if text_content %}
    <div class="no-audio-text">{{ text_content }}</div>
    {% endif %}
    {% endif %}

    {% if options %}
    <div id="choices" class="{% if audio_url %}hidden{% else %}visible{% endif %}">
        {% for option in options %}
        <a class="choice-btn"
           href="{{ url_for('books.play_waypoint', book_id=book.id, waypoint_id=option.destinationWaypoint_id) }}">
            {{ option.linkText }}
        </a>
        {% endfor %}
    </div>

    {% if audio_url %}
    <button class="skip-btn" id="skip-btn">Show choices early</button>
    {% endif %}

    {% else %}
    <div id="choices" class="{% if audio_url %}hidden{% else %}visible{% endif %}">
        <div class="story-end">
            <h2>The End</h2>
            <a class="library-btn" href="{{ url_for('books.index') }}">Return to library</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
(function() {
    var audio = document.getElementById('story-audio');
    var choices = document.getElementById('choices');
    var skipBtn = document.getElementById('skip-btn');
    var transcriptBtn = document.getElementById('transcript-btn');
    var transcript = document.getElementById('transcript');
    var audioError = document.getElementById('audio-error');

    function revealChoices() {
        if (choices) {
            choices.classList.remove('hidden');
            choices.classList.add('visible');
        }
        if (skipBtn) {
            skipBtn.style.display = 'none';
        }
    }

    if (audio) {
        audio.addEventListener('ended', revealChoices);

        /* Handle audio load failure (404, network error, bad format) */
        audio.addEventListener('error', function() {
            audio.style.display = 'none';
            if (audioError) audioError.style.display = 'block';
            /* Show transcript and choices as fallback */
            if (transcript) {
                transcript.classList.add('open');
                if (transcriptBtn) transcriptBtn.style.display = 'none';
            }
            revealChoices();
        });
    }

    if (skipBtn) {
        skipBtn.addEventListener('click', revealChoices);
    }

    if (transcriptBtn && transcript) {
        transcriptBtn.addEventListener('click', function() {
            transcript.classList.toggle('open');
            transcriptBtn.textContent = transcript.classList.contains('open')
                ? 'Hide transcript' : 'Read transcript';
        });
    }
})();
</script>
{% endblock %}
